{"changed":false,"filter":false,"title":"FormField.vue","tooltip":"/vendor/ali-awwad/create-relation-on-resource/resources/js/components/BelongsToWithCreate/FormField.vue","value":"<template>\n  <default-field :field=\"field\" :errors=\"errors\">\n    <template slot=\"field\">\n        <div class=\"flex items-center\">\n      <search-input\n        v-if=\"isSearchable && !isLocked && !isReadonly\"\n        :data-testid=\"`${field.resourceName}-search-input`\"\n        @input=\"performSearch\"\n        @clear=\"clearSelection\"\n        @selected=\"selectResource\"\n        :error=\"hasError\"\n        :value=\"selectedResource\"\n        :data=\"availableResources\"\n        :clearable=\"field.nullable\"\n        trackBy=\"value\"\n        searchBy=\"display\"\n        class=\"mb-3\"\n      >\n        <div slot=\"default\" v-if=\"selectedResource\" class=\"flex items-center\">\n          <div v-if=\"selectedResource.avatar\" class=\"mr-3\">\n            <img :src=\"selectedResource.avatar\" class=\"w-8 h-8 rounded-full block\" />\n          </div>\n          {{ selectedResource.display }}\n        </div>\n\n        <div slot=\"option\" slot-scope=\"{ option, selected }\" class=\"flex items-center\">\n          <div v-if=\"option.avatar\" class=\"mr-3\">\n            <img :src=\"option.avatar\" class=\"w-8 h-8 rounded-full block\" />\n          </div>\n          {{ option.display }}\n        </div>\n      </search-input>\n\n      <select-control\n        v-if=\"!isSearchable || isLocked || isReadonly\"\n        class=\"form-control form-select mb-3 w-full\"\n        :class=\"{ 'border-danger': hasError }\"\n        :data-testid=\"`${field.resourceName}-select`\"\n        :dusk=\"field.attribute\"\n        @change=\"selectResourceFromSelectControl\"\n        :disabled=\"isLocked || isReadonly\"\n        :options=\"availableResources\"\n        :value=\"selectedResourceId\"\n        :selected=\"selectedResourceId\"\n        label=\"display\"\n      >\n        <option value selected :disabled=\"!field.nullable\">&mdash;</option>\n      </select-control>\n\n      <a\n        v-if=\"field.quickCreate && !isModal\"\n        class=\"cursor-pointer mx-1 mb-3 items-center flex\"\n        @click=\"openModal = true\"\n      >\n        <svg class=\"svg-icon fill-current hover:text-danger text-primary\" viewBox=\"0 0 20 20\">\n          <path\n            d=\"M14.613,10c0,0.23-0.188,0.419-0.419,0.419H10.42v3.774c0,0.23-0.189,0.42-0.42,0.42s-0.419-0.189-0.419-0.42v-3.774H5.806c-0.23,0-0.419-0.189-0.419-0.419s0.189-0.419,0.419-0.419h3.775V5.806c0-0.23,0.189-0.419,0.419-0.419s0.42,0.189,0.42,0.419v3.775h3.774C14.425,9.581,14.613,9.77,14.613,10 M17.969,10c0,4.401-3.567,7.969-7.969,7.969c-4.402,0-7.969-3.567-7.969-7.969c0-4.402,3.567-7.969,7.969-7.969C14.401,2.031,17.969,5.598,17.969,10 M17.13,10c0-3.932-3.198-7.13-7.13-7.13S2.87,6.068,2.87,10c0,3.933,3.198,7.13,7.13,7.13S17.13,13.933,17.13,10\"\n          />\n        </svg>\n      </a>\n      <portal to=\"modals\">\n          <modal-create\n            v-if=\"openModal &&  !isModal\"\n            :resourceName=\"field.resourceName\"\n            :fillValues=\"field.fillValues\"\n            @confirm=\"reloadResources\"\n            @close=\"openModal = false\"\n          ></modal-create>\n      </portal>\n      <!-- Trashed State -->\n      <div v-if=\"shouldShowTrashed\">\n        <checkbox-with-label\n          :dusk=\"`${field.resourceName}-with-trashed-checkbox`\"\n          :checked=\"withTrashed\"\n          @change=\"toggleWithTrashed\"\n        >{{ __('With Trashed') }}</checkbox-with-label>\n      </div>\n        </div>\n    </template>\n  </default-field>\n</template>\n\n<script>\nimport _ from \"lodash\";\nimport storage from \"../../storage/BelongsToFieldStorage\";\nimport {\n  TogglesTrashed,\n  PerformsSearches,\n  HandlesValidationErrors\n} from \"laravel-nova\";\nimport ModalCreate from \"../Modals/ModalCreate\";\n\nexport default {\n  components: {\n    \"modal-create\": ModalCreate\n  },\n  mixins: [TogglesTrashed, PerformsSearches, HandlesValidationErrors],\n  props: {\n    isModal: {\n      type: Boolean,\n      default: false\n    },\n    resourceName: String,\n    resourceId: {},\n    field: Object,\n    viaResource: {},\n    viaResourceId: {},\n    viaRelationship: {}\n  },\n\n  data: () => ({\n    openModal: false,\n    availableResources: [],\n    initializingWithExistingResource: false,\n    selectedResource: null,\n    selectedResourceId: null,\n    softDeletes: false,\n    withTrashed: false,\n    search: \"\"\n  }),\n\n  /**\n   * Mount the component.\n   */\n  mounted() {\n    this.initializeComponent();\n  },\n\n  methods: {\n    async reloadResources(id) {\n      this.loading = true;\n      await this.getAvailableResources();\n      if (id) {\n        this.selectedResourceId = id;\n        this.selectInitialResource();\n      }\n      this.openModal = false;\n      this.loading = false;\n    },\n    initializeComponent() {\n      this.withTrashed = false;\n\n      // If a user is editing an existing resource with this relation\n      // we'll have a belongsToId on the field, and we should prefill\n      // that resource in this field\n      if (this.editingExistingResource) {\n        this.initializingWithExistingResource = true;\n        this.selectedResourceId = this.field.belongsToId;\n      }\n\n      // If the user is creating this resource via a related resource's index\n      // page we'll have a viaResource and viaResourceId in the params and\n      // should prefill the resource in this field with that information\n      if (this.creatingViaRelatedResource) {\n        this.initializingWithExistingResource = true;\n        this.selectedResourceId = this.viaResourceId;\n      }\n\n      if (this.shouldSelectInitialResource && !this.isSearchable) {\n        // If we should select the initial resource but the field is not\n        // searchable we should load all of the available resources into the\n        // field first and select the initial option\n        this.initializingWithExistingResource = false;\n        this.getAvailableResources().then(() => this.selectInitialResource());\n      } else if (this.shouldSelectInitialResource && this.isSearchable) {\n        // If we should select the initial resource and the field is\n        // searchable, we won't load all the resources but we will select\n        // the initial option\n        this.getAvailableResources().then(() => this.selectInitialResource());\n      } else if (!this.shouldSelectInitialResource && !this.isSearchable) {\n        // If we don't need to select an initial resource because the user\n        // came to create a resource directly and there's no parent resource,\n        // and the field is searchable we'll just load all of the resources\n        this.getAvailableResources();\n      }\n\n      this.determineIfSoftDeletes();\n\n      this.field.fill = this.fill;\n    },\n\n    /**\n     * Select a resource using the <select> control\n     */\n    selectResourceFromSelectControl(e) {\n      this.selectedResourceId = e.target.value;\n      this.selectInitialResource();\n    },\n\n    /**\n     * Fill the forms formData with details from this field\n     */\n    fill(formData) {\n      formData.append(\n        this.field.attribute,\n        this.selectedResource ? this.selectedResource.value : \"\"\n      );\n\n      formData.append(this.field.attribute + \"_trashed\", this.withTrashed);\n    },\n\n    /**\n     * Get the resources that may be related to this resource.\n     */\n    getAvailableResources() {\n      return storage\n        .fetchAvailableResources(\n          this.resourceName,\n          this.field.attribute,\n          this.queryParams\n        )\n        .then(({ data: { resources, softDeletes, withTrashed } }) => {\n          if (this.initializingWithExistingResource || !this.isSearchable) {\n            this.withTrashed = withTrashed;\n          }\n\n          // Turn off initializing the existing resource after the first time\n          this.initializingWithExistingResource = false;\n          this.availableResources = resources;\n          this.softDeletes = softDeletes;\n        });\n    },\n\n    /**\n     * Determine if the relatd resource is soft deleting.\n     */\n    determineIfSoftDeletes() {\n      console.log(this.field);\n\n      return storage\n        .determineIfSoftDeletes(this.field.resourceName)\n        .then(response => {\n          this.softDeletes = response.data.softDeletes;\n        });\n    },\n\n    /**\n     * Determine if the given value is numeric.\n     */\n    isNumeric(value) {\n      return !isNaN(parseFloat(value)) && isFinite(value);\n    },\n\n    /**\n     * Select the initial selected resource\n     */\n    selectInitialResource() {\n      this.selectedResource = _.find(\n        this.availableResources,\n        r => r.value == this.selectedResourceId\n      );\n    },\n\n    /**\n     * Toggle the trashed state of the search\n     */\n    toggleWithTrashed() {\n      this.withTrashed = !this.withTrashed;\n\n      // Reload the data if the component doesn't support searching\n      if (!this.isSearchable) {\n        this.getAvailableResources();\n      }\n    }\n  },\n\n  computed: {\n    /**\n     * Determine if we are editing and existing resource\n     */\n    editingExistingResource() {\n      return Boolean(this.field.belongsToId);\n    },\n\n    /**\n     * Determine if we are creating a new resource via a parent relation\n     */\n    creatingViaRelatedResource() {\n      return (\n        this.viaResource == this.field.resourceName &&\n        this.field.reverse &&\n        this.viaResourceId\n      );\n    },\n\n    /**\n     * Determine if we should select an initial resource when mounting this field\n     */\n    shouldSelectInitialResource() {\n      return Boolean(\n        this.editingExistingResource || this.creatingViaRelatedResource\n      );\n    },\n\n    /**\n     * Determine if the related resources is searchable\n     */\n    isSearchable() {\n      return this.field.searchable;\n    },\n\n    /**\n     * Get the query params for getting available resources\n     */\n    queryParams() {\n      return {\n        params: {\n          current: this.selectedResourceId,\n          first: this.initializingWithExistingResource,\n          search: this.search,\n          withTrashed: this.withTrashed,\n          resourceId: this.resourceId,\n          viaResource: this.viaResource,\n          viaResourceId: this.viaResourceId,\n          viaRelationship: this.viaRelationship\n        }\n      };\n    },\n\n    isLocked() {\n      return this.viaResource == this.field.resourceName && this.field.reverse;\n    },\n\n    isReadonly() {\n      return (\n        this.field.readonly || _.get(this.field, \"extraAttributes.readonly\")\n      );\n    },\n\n    shouldShowTrashed() {\n      return (\n        this.softDeletes &&\n        !this.isLocked &&\n        !this.isReadonly &&\n        this.field.displaysWithTrashed\n      );\n    }\n  }\n};\n</script>\n\n\n<style>\n.svg-icon {\n  width: 2em;\n  height: 2em;\n}\n\n.svg-icon circle {\n  /* stroke: #fff; */\n  stroke-width: 1;\n}\n</style>","undoManager":{"mark":-1,"position":-1,"stack":[]},"ace":{"folds":[],"scrolltop":1201.5,"scrollleft":0,"selection":{"start":{"row":70,"column":24},"end":{"row":70,"column":24},"isBackwards":false},"options":{"guessTabSize":true,"useWrapMode":false,"wrapToView":true},"firstLineState":{"row":62,"state":"tag_stuff","mode":"ace/mode/html"}},"timestamp":1576180688000}